pipeline {
    agent any
    environment{
        KUBESPRAY_DIR= "kubespray"
    }

    stages {
        
        nodes("develop"){
        stage('Prepare Tools') {
            steps {
                
                echo 'Preparing tools...'
                sh "apt-get install python3 python3-pip -y"
                sh "git clone https://github.com/kubernetes-sigs/kubespray.git"
                sh "pip install -r ${KUBESPRAY_DIR}/requirements-2.12.txt"
            
            }
        }
        stage('Build') {
            steps {
                echo 'Build...'
                sh "cp -rfp ${KUBESPRAY_DIR}/inventory/sample ${KUBESPRAY_DIR}/inventory/mycluster"
            //    sh 'declare -a IPS=(172.168.8.1 172.168.8.2 172.168.8.3)'
                sh 'CONFIG_FILE=kubespray/inventory/mycluster/hosts.yaml python3 kubespray/contrib/inventory_builder/inventory.py 172.168.8.1 172.168.8.2 172.168.8.3'
                sh "curl https://raw.githubusercontent.com/Michal944/Jobs/master/hosts.yaml -o ${KUBESPRAY_DIR}/inventory/mycluster/hosts.yaml"
                sh "cat ${KUBESPRAY_DIR}/inventory/mycluster/hosts.yaml"
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying....'
            }
        }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}